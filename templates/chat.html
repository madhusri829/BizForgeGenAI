{% extends "base.html" %}
{% block title %}Chat - BizForge{% endblock %}
{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto; min-height: 500px; display: flex; flex-direction: column;">
    <h2 class="text-center">Brand Assistant</h2>
    <div id="chatBox"
        style="flex: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; overflow-y: auto; margin-bottom: 1rem; background: #f9fafb;">
        <!-- Messages go here -->
    </div>
    <form id="chatForm" style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="message" placeholder="Ask about branding..." required>
        <button type="submit" class="btn btn-primary">Send</button>
    </form>
</div>
{% endblock %}
{% block scripts %}
<script>
    const chatBox = document.getElementById('chatBox');
    let history = [];

    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.style.marginBottom = '0.5rem';
        div.style.padding = '0.5rem';
        div.style.borderRadius = '0.5rem';
        div.style.maxWidth = '80%';

        if (role === 'User') {
            div.style.backgroundColor = '#e0e7ff';
            div.style.marginLeft = 'auto';
            div.textContent = text;
        } else {
            div.style.backgroundColor = '#ffffff';
            div.style.border = '1px solid #e5e7eb';
            div.textContent = text;
        }
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById('chatForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('message');
        const message = input.value;
        input.value = '';

        appendMessage('User', message);

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, history })
            });

            const data = await res.json();
            appendMessage('Assistant', data.reply);

            history.push({ role: 'user', content: message });
            history.push({ role: 'assistant', content: data.reply });

        } catch (e) { alert('Error sending message'); }
    });
</script>
{% endblock %}